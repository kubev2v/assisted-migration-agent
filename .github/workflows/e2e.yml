name: Run e2e tests

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      AGENT_IMAGE: assisted-migration-agent:e2e
      BACKEND_IMAGE: migration-planner-api
      BACKEND_TAG: e2e

    steps:
      - name: Checkout agent code
        uses: actions/checkout@v4

      - name: Checkout migration-planner
        uses: actions/checkout@v4
        with:
          repository: kubev2v/migration-planner
          path: migration-planner

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Start Podman socket
        run: |
          systemctl --user enable --now podman.socket
          echo "PODMAN_SOCKET=unix://$XDG_RUNTIME_DIR/podman/podman.sock" >> $GITHUB_ENV

      - name: Build backend API container
        run: |
          cd migration-planner
          make migration-planner-api-container MIGRATION_PLANNER_API_IMAGE=${{ env.BACKEND_IMAGE }} MIGRATION_PLANNER_API_IMAGE_TAG=${{ env.BACKEND_TAG }}

      - name: Build agent container
        run: |
          make image IMAGE_NAME=assisted-migration-agent IMAGE_TAG=e2e

      - name: Build e2e binary
        run: make build.e2e

      - name: Pull test images
        run: |
          podman pull docker.io/library/postgres:17
          podman pull docker.io/vmware/vcsim:latest

      - name: Run e2e tests
        run: |
          ./bin/e2e \
            -backend-image=${{ env.BACKEND_IMAGE }}:${{ env.BACKEND_TAG }} \
            -agent-image=${{ env.AGENT_IMAGE }} \
            -podman-socket=${{ env.PODMAN_SOCKET }} \
            --ginkgo.v
